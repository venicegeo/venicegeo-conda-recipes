#!/usr/bin/groovy

node {
    def root = pwd()
    def golangTool = tool 'golang_1.7'

	stage("Setup") {
		deleteDir()
		if(env.GITLAB_CREDS) {
		  	git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}", credentialsId: "${env.GITLAB_CREDS}"
		} else {
		  	git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
		}        
		sh """
		  git submodule init
		  git submodule update
		  git submodule foreach -q --recursive 'git checkout $(git config -f \$toplevel/.gitmodules submodule.\$name.checkout)'
		  git submodule
		"""
		sh """
		  rm -f $HOME/.condarc
		  curl -L https://repo.continuum.io/miniconda/Miniconda2-4.3.21-Linux-x86_64.sh -o miniconda.sh
		  bash miniconda.sh -b -p $root/miniconda2
		  rm miniconda.sh
		"""
    }
    
	stage("Conda Build") {
		withEnv([
		  "PATH+=${golangTool}/bin:${root}/miniconda2/bin",
		  "GOROOT=${golangTool}",
		]) {
			withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACT_READ_ONLY_CREDS}", usernameVariable: 'NEXUSUSER', passwordVariable: 'NEXUSPASS']]) {
				sh """
				  sed -i "s*SED_CREDS_CHANNEL*`echo $CONDA_CHANNEL_CREDS_URL | sed -e "s/NEXUSUSER/${NEXUSUSER}/g" | sed -e "s/NEXUSPASS/${NEXUSPASS}/g"`*g" recipe-script.sh
				  sed -i "s*SED_CHANNEL*$CONDA_CHANNEL_URL*g" recipe-script.sh
				  sed -i "s*SED_USER*$NEXUSUSER*g" recipe-script.sh
				  sed -i "s*SED_PASS*$NEXUSPASS*g" recipe-script.sh
				  sed -i "s*SED_LOC*$root*g" recipe-script.sh
				  go env
				  echo $GOROOT
				  bash recipe-script.sh
				"""
			}
		}
	}
    
    stage("Nexus Deploy") {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACT_STORAGE_CREDS}", usernameVariable: 'NEXUSUSER', passwordVariable: 'NEXUSPASS']]) {
		sh 'for f in $(find linux-64 -type f); do curl -T $f -u $NEXUSUSER:$NEXUSPASS $CONDA_CHANNEL_URL/$f; done'
        }
    }
}
