node {
  def root = pwd()
  def golangTool = tool 'golang_1.7'
  
  def gitSimple = {
      git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
      sh "git submodule init"
      sh "git submodule update"
      sh "git submodule foreach -q --recursive 'git checkout \$(git config -f \$toplevel/.gitmodules submodule.\$name.checkout)'"
      sh "git submodule"
  }
  
  def gitComplex = {
            sh """
i=0
for line in `cat .gitmodules`;do
  if [ \$((i%11)) = 4 ];then
    folder=\$line
  fi
  if [ \$((i%11)) = 7 ];then
    url=\$line
  fi
  if [ \$((i%11)) = 10 ];then
    checkout=\$line
  
    echo \$folder \$url \$checkout >> modules.txt  
  fi
  i=\$((i+1))
    
done

      """
      
      def testArr = sh(script: """cat modules.txt""", returnStdout:true).trim().split("\n")
      sh "rm modules.txt"

      
        for (int i = 0; i < testArr.size(); i++) {
            def parts = testArr[i].split(" ");
            def folder = parts[0]
            def url = parts[1]
            def tag = parts[2]
            dir(folder){
                git url: url, credentialsId: "${env.GITLAB_CREDS}"
                sh "git checkout $tag"
            }
        }
  }

  stage("Setup") {
    deleteDir()
    sh "rm -rf /jslave/.conda/"
    sh "rm -rf /jslave/.condarc"
    if(env.GITLAB_CREDS) {
      git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}", credentialsId: "${env.GITLAB_CREDS}"
      sh "sed -i 's,https://github.com/venicegeo/,${params.GIT_BASE_URL},g' .gitmodules"
      //checkout([$class: "GitSCM", branches: [[name: "${env.GIT_BRANCH}"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: "SubmoduleOption", disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: "", trackingSubmodules: true]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: "${env.GITLAB_CREDS}", url: "${env.GIT_URL}"]]])
      gitComplex()
    } else {
      gitSimple()
    }
      sh "curl -L https://repo.continuum.io/miniconda/Miniconda2-4.3.21-Linux-x86_64.sh -o miniconda.sh"
      sh "bash miniconda.sh -b -p ${root}/miniconda2"
      sh "rm miniconda.sh"
  }
  
  def condaBuild = {
      sh """
               echo Clearing out conda-bld
               rm -rf ${root}/miniconda2/conda-bld
               echo Removing defaults
               conda config --remove channels defaults || true
               echo Adding nexus
               echo "${env.CONDA_CHANNEL_URL}"
               conda config --add channels `echo $CONDA_CHANNEL_CREDS_URL | sed -e "s/NEXUSUSER/${NEXUSUSER}/g" | sed -e "s/NEXUSPASS/${NEXUSPASS}/g"`
               conda config --add channels conda-forge || true
               conda config --show
               conda config --set anaconda_upload yes
               conda info
               conda install conda-build -y -q
               echo Rebuilding conda-bld
               mkdir -p ${root}/miniconda2/conda-bld/linux-64
               mkdir -p ${root}/miniconda2/conda-bld/noarch
               conda index ${root}/miniconda2/conda-bld/linux-64
               conda index ${root}/miniconda2/conda-bld/noarch
               echo Adding local
               conda config --add channels local
               cd recipes
               vendoredFolders=\$(ls)
               for f in \$vendoredFolders; do
                 echo "Starting build for \$f"
                 conda build \$f --old-build-string -q
               done
               cd ..
               toKeep=\$(ls ${root}/miniconda2/conda-bld/linux-64)
               for f in \$toKeep; do
                 echo \$f
               done
               mkdir linux-64 && cd linux-64
               wget -q -r -l1 -e robots=off -nH -nd --reject="index.html*" --no-parent --no-cookies "${env.CONDA_CHANNEL_URL}"/linux-64/ --user=$NEXUSUSER --password=$NEXUSPASS
               mv ${root}/miniconda2/conda-bld/linux-64/* .
               conda index .
               deleteString="find . -type f"
               for f in \$toKeep; do
                 deleteString=\$deleteString" ! -name \$f"
               done
               deleteString=\$deleteString" -delete"
               \$deleteString
               """
  }

  stage("Conda Build") {
    withEnv([
      "PATH+=${golangTool}/bin:${root}/miniconda2/bin",
      "GOROOT=${golangTool}",
    ]) {
      withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACT_READ_ONLY_CREDS}", usernameVariable: 'NEXUSUSER', passwordVariable: 'NEXUSPASS']]) {
        if(env.CA_CERT_BUNDLE_PATH) {
          withEnv(["REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-bundle.crt"]) {
              condaBuild()
            }
        } else{
            condaBuild()
        }
        }
      }
   }

  stage("Nexus Deploy") {
      withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACT_STORAGE_CREDS}", usernameVariable: 'NEXUSUSER', passwordVariable: 'NEXUSPASS']]) {
        sh 'for f in $(find linux-64 -type f); do curl -T $f -u $NEXUSUSER:$NEXUSPASS $CONDA_CHANNEL_URL/$f; done'
      }
  }
}
